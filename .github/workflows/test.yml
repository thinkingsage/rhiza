name: Rhiza Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      neo4j:
        image: neo4j:5.15-community
        env:
          NEO4J_AUTH: neo4j/password
          NEO4J_PLUGINS: '["apoc"]'
        ports:
          - 7474:7474
          - 7687:7687
        options: >-
          --health-cmd "cypher-shell -u neo4j -p password 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl jq bc

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install API dependencies
      run: |
        cd rhiza-api
        pip install poetry
        poetry lock
        poetry install --no-root

    - name: Install UI dependencies
      run: |
        cd rhiza-ui
        npm install

    - name: Start API
      run: |
        cd rhiza-api
        NEO4J_URI=bolt://localhost:7687 \
        NEO4J_PASSWORD=password \
        GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} \
        AWS_BEARER_TOKEN_BEDROCK=${{ secrets.AWS_BEARER_TOKEN_BEDROCK }} \
        poetry run uvicorn main:app --host 0.0.0.0 --port 8000 &

    - name: Start UI
      run: |
        cd rhiza-ui
        VITE_API_URL=http://localhost:8000 npm run dev -- --host 0.0.0.0 --port 5173 &

    - name: Wait for Neo4j
      run: |
        echo "Waiting for Neo4j to be ready..."
        for i in {1..30}; do
          if curl -f -s http://localhost:7474 > /dev/null; then
            echo "Neo4j is ready"
            break
          fi
          echo "Attempt $i/30: Neo4j not ready yet..."
          sleep 2
        done

    - name: Load test data
      run: |
        echo "Loading test data..."
        sleep 5
        cat data/cypher/complete_enriched_seed.cypher | docker exec -i $(docker ps -q --filter ancestor=neo4j:5.15-community) cypher-shell -u neo4j -p password

    - name: Wait for services
      run: |
        echo "Waiting for API to be ready..."
        for i in {1..30}; do
          if curl -f -s http://localhost:8000/health > /dev/null; then
            echo "API is ready"
            break
          fi
          echo "Attempt $i/30: API not ready yet..."
          sleep 2
        done

        echo "Waiting for UI to be ready..."
        for i in {1..30}; do
          if curl -f -s http://localhost:5173 > /dev/null; then
            echo "UI is ready"
            break
          fi
          echo "Attempt $i/30: UI not ready yet..."
          sleep 2
        done

    - name: Run test suite
      run: |
        export API_BASE_URL=http://localhost:8000
        export UI_BASE_URL=http://localhost:5173
        export NEO4J_URL=http://localhost:7474
        ./scripts/test.sh --ci

    - name: Collect logs on failure
      if: failure()
      run: |
        echo "=== Process Status ==="
        ps aux | grep -E "(uvicorn|npm)" || true
        echo "=== Neo4j Logs ==="
        docker logs $(docker ps -q --filter ancestor=neo4j:5.15-community) || true

    - name: Cleanup
      if: always()
      run: |
        pkill -f uvicorn || true
        pkill -f "npm run dev" || true
